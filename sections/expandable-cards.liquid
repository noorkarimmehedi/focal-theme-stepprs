{% comment %}
  Expandable Cards Section
  Animated expandable card carousel with smooth transitions
{% endcomment %}

<style>
  .expandable-cards-section-{{ section.id }} {
    width: 100%;
    padding: {{ section.settings.padding_top }}px {{ section.settings.padding_right }}px {{ section.settings.padding_bottom }}px {{ section.settings.padding_left }}px;
    background-color: {{ section.settings.background_color }};
    position: relative;
  }

  .expandable-cards-section-{{ section.id }} .section-title {
    text-align: center;
    margin-bottom: 2rem;
    font-family: {{ section.settings.title_font.family }}, {{ section.settings.title_font.fallback_families }};
    font-weight: {{ section.settings.title_font.weight }};
    font-style: {{ section.settings.title_font.style }};
    font-size: {{ section.settings.title_size }}px;
    color: {{ section.settings.title_color }};
  }

  {{ section.settings.title_font | font_face: font_display: 'swap' }}

  .expandable-cards-container {
    display: flex;
    overflow-x: auto;
    padding: 1rem 0 2rem;
    margin: 0 auto;
    scroll-snap-type: x mandatory;
    -ms-overflow-style: none;
    scrollbar-width: none;
    perspective: 1000px;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .expandable-cards-container {
      justify-content: flex-start;
      scroll-padding-left: 20%;
    }
  }

  .expandable-cards-container::-webkit-scrollbar {
    display: none;
  }

  .expandable-card {
    position: relative;
    width: 200px;
    height: 300px;
    margin-right: 1rem;
    flex-shrink: 0;
    cursor: pointer;
    overflow: hidden;
    border-radius: {{ section.settings.card_radius }}px;
    border: 1px solid {{ section.settings.card_border_color }};
    background: {{ section.settings.card_background }};
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.3s ease,
                opacity 0.3s ease;
    scroll-snap-align: start;
    transform-origin: center center;
  }

  .expandable-card.side-card {
    transform: scale(0.85) translateY(10px);
    opacity: 0.7;
  }

  .expandable-card.center-card {
    transform: scale(1) translateY(0);
    opacity: 1;
    z-index: 2;
  }

  .expandable-card.expanded {
    width: 500px;
  }

  .card-image-container {
    position: relative;
    height: 100%;
    width: 200px;
  }

  .card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.2);
  }

  .card-content-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 1.5rem;
    color: white;
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0;
  }

  .card-play-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-play-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(8px);
    border: none;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .card-play-button:hover {
    transform: scale(1.1);
  }

  .card-play-button.playing {
    background: rgba(255, 255, 255, 0.5);
  }

  .card-play-icon {
    width: 1.5rem;
    height: 1.5rem;
    color: white;
  }

  .card-video-container {
    position: absolute;
    inset: 0;
    background: black;
    display: none;
    z-index: 10;
  }

  .card-video-container.active {
    display: block;
  }

  .card-video-container video,
  .card-video-container iframe {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-video-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 2rem;
    height: 2rem;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 11;
    transition: background 0.2s;
  }

  .card-video-close:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .card-play-text {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .card-details {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: 0;
    background: {{ section.settings.card_background }};
    opacity: 0;
    overflow: hidden;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s ease 0.2s;
  }

  .expandable-card.expanded .card-details {
    width: 300px;
    opacity: 1;
  }

  .card-details-content {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    padding: 2rem;
    opacity: 0;
    transform: translateX(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .expandable-card.expanded .card-details-content {
    opacity: 1;
    transform: translateX(0);
    transition-delay: 0.4s;
  }

  .card-description {
    font-size: 0.875rem;
    color: #4b5563;
    margin: 0;
  }

  .card-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .card-author-image {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    overflow: hidden;
    border: 1px solid #e5e7eb;
  }

  .card-author-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-author-name {
    font-weight: 600;
    color: #111827;
    margin: 0;
  }

  .card-author-role {
    font-size: 0.75rem;
    color: #6b7280;
    margin: 0;
  }

  .carousel-navigation {
    display: flex !important;
    position: absolute;
    bottom: 2rem;
    right: 2rem;
    gap: 0.75rem;
    z-index: 9999;
  }

  @media (min-width: 769px) {
    .carousel-navigation {
      display: none !important;
    }
  }

  .nav-arrow {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .nav-arrow:active {
    transform: scale(0.95);
  }

  .nav-arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .nav-arrow svg {
    width: 1.25rem;
    height: 1.25rem;
    color: white;
  }
</style>

<div class="expandable-cards-section-{{ section.id }}">
  {% if section.settings.section_title != blank %}
    <h2 class="section-title">{{ section.settings.section_title }}</h2>
  {% endif %}
  
  <div class="expandable-cards-container" id="expandable-cards-{{ section.id }}">
    {% for block in section.blocks %}
      <div class="expandable-card" data-card-id="{{ block.id }}" {{ block.shopify_attributes }}>
        <div class="card-image-container">
          {% if block.settings.image %}
            <img 
              class="card-image" 
              src="{{ block.settings.image | image_url: width: 400 }}"
              alt="{{ block.settings.title }}"
              loading="lazy"
            >
          {% else %}
            <div class="card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
          {% endif %}
          <div class="card-overlay"></div>
          <div class="card-content-overlay">
            <h2 class="card-title">{{ block.settings.title }}</h2>
            {% if block.settings.video or block.settings.video_url != blank %}
              <div class="card-play-section">
                <button class="card-play-button" type="button" aria-label="Play video" data-play-btn>
                  <svg class="card-play-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3l14 9-14 9V3z"/>
                  </svg>
                </button>
                <span class="card-play-text">Play video</span>
              </div>
            {% endif %}
          </div>
          
          {% if block.settings.video or block.settings.video_url != blank %}
            <div class="card-video-container" data-video-container>
              <button class="card-video-close" data-video-close aria-label="Close video">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              {% if block.settings.video %}
                {{ block.settings.video | video_tag: autoplay: false, controls: true, muted: false }}
              {% elsif block.settings.video_url != blank %}
                <iframe 
                  src="{{ block.settings.video_url }}" 
                  frameborder="0" 
                  allow="autoplay; fullscreen; picture-in-picture" 
                  allowfullscreen
                ></iframe>
              {% endif %}
            </div>
          {% endif %}
        </div>
        <div class="card-details">
          <div class="card-details-content">
            <p class="card-description">{{ block.settings.description }}</p>
            {% if block.settings.author_name != blank %}
              <div class="card-author">
                <div class="card-author-image">
                  {% if block.settings.author_image %}
                    <img 
                      src="{{ block.settings.author_image | image_url: width: 96 }}"
                      alt="{{ block.settings.author_name }}"
                    >
                  {% else %}
                    <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                  {% endif %}
                </div>
                <div>
                  <p class="card-author-name">{{ block.settings.author_name }}</p>
                  <p class="card-author-role">{{ block.settings.author_role }}</p>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
    <div class="carousel-navigation" id="carousel-nav-{{ section.id }}">
      <button class="nav-arrow" id="prev-arrow-{{ section.id }}" type="button" aria-label="Previous card">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      <button class="nav-arrow" id="next-arrow-{{ section.id }}" type="button" aria-label="Next card">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  (function() {
    const container = document.getElementById('expandable-cards-{{ section.id }}');
    const cards = container.querySelectorAll('.expandable-card');
    const prevArrow = document.getElementById('prev-arrow-{{ section.id }}');
    const nextArrow = document.getElementById('next-arrow-{{ section.id }}');
    let selectedCard = null;
    let currentIndex = 0;

    // Center scroll on load for mobile only
    if (container && window.innerWidth <= 768) {
      const scrollWidth = container.scrollWidth;
      const clientWidth = container.clientWidth;
      container.scrollLeft = (scrollWidth - clientWidth) / 2;
    }
    
    updateCardScales();
    updateArrowStates();

    // Function to update card scales based on position
    function updateCardScales() {
      const containerRect = container.getBoundingClientRect();
      const containerCenter = containerRect.left + containerRect.width / 2;

      cards.forEach((card, index) => {
        const cardRect = card.getBoundingClientRect();
        const cardCenter = cardRect.left + cardRect.width / 2;
        const distanceFromCenter = Math.abs(containerCenter - cardCenter);
        
        // Calculate if card is in center (within 150px threshold)
        if (distanceFromCenter < 150) {
          card.classList.add('center-card');
          card.classList.remove('side-card');
          currentIndex = index;
        } else {
          card.classList.add('side-card');
          card.classList.remove('center-card');
        }
      });
      
      updateArrowStates();
    }

    // Function to update arrow button states
    function updateArrowStates() {
      if (prevArrow && nextArrow) {
        prevArrow.disabled = currentIndex === 0;
        nextArrow.disabled = currentIndex === cards.length - 1;
      }
    }

    // Function to scroll to a specific card
    function scrollToCard(index) {
      if (index >= 0 && index < cards.length) {
        cards[index].scrollIntoView({
          behavior: 'smooth',
          block: 'nearest',
          inline: 'center'
        });
        currentIndex = index;
        updateArrowStates();
      }
    }

    // Arrow button click handlers
    if (prevArrow) {
      prevArrow.addEventListener('click', function() {
        scrollToCard(currentIndex - 1);
      });
    }

    if (nextArrow) {
      nextArrow.addEventListener('click', function() {
        scrollToCard(currentIndex + 1);
      });
    }

    // Update scales on scroll
    container.addEventListener('scroll', updateCardScales);

    // Update on resize
    window.addEventListener('resize', updateCardScales);

    cards.forEach(card => {
      const playBtn = card.querySelector('[data-play-btn]');
      const videoContainer = card.querySelector('[data-video-container]');
      const videoClose = card.querySelector('[data-video-close]');
      const video = videoContainer ? videoContainer.querySelector('video') : null;

      // Play button click
      if (playBtn && videoContainer) {
        playBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          videoContainer.classList.add('active');
          playBtn.classList.add('playing');
          
          // Auto-play video if it's a native video
          if (video) {
            video.play();
          }
        });
      }

      // Close button click
      if (videoClose && videoContainer) {
        videoClose.addEventListener('click', function(e) {
          e.stopPropagation();
          videoContainer.classList.remove('active');
          if (playBtn) {
            playBtn.classList.remove('playing');
          }
          
          // Pause video if it's a native video
          if (video) {
            video.pause();
            video.currentTime = 0;
          }
        });
      }

      // Card click (expand/collapse)
      card.addEventListener('click', function(e) {
        // Don't expand if clicking video container
        if (videoContainer && videoContainer.classList.contains('active')) {
          return;
        }

        const cardId = this.getAttribute('data-card-id');
        
        if (selectedCard === cardId) {
          // Deselect
          this.classList.remove('expanded');
          selectedCard = null;
        } else {
          // Remove expanded class from all cards
          cards.forEach(c => c.classList.remove('expanded'));
          
          // Expand clicked card
          this.classList.add('expanded');
          selectedCard = cardId;
          
          // Scroll to center the card
          this.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
          });
        }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Expandable Cards",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Featured Content"
    },
    {
      "type": "font_picker",
      "id": "title_font",
      "label": "Title Font",
      "default": "assistant_n4"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 20,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "Title Size",
      "default": 40
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section Background Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_left",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Left",
      "default": 16
    },
    {
      "type": "range",
      "id": "padding_right",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Right",
      "default": 16
    },
    {
      "type": "header",
      "content": "Card Settings"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card Border Color",
      "default": "#e5e7eb"
    },
    {
      "type": "range",
      "id": "card_radius",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Card Border Radius",
      "default": 16
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Card Title"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Card Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (optional)"
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "External Video URL (YouTube/Vimeo)"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Card description goes here."
        },
        {
          "type": "text",
          "id": "author_name",
          "label": "Author Name",
          "default": "John Doe"
        },
        {
          "type": "text",
          "id": "author_role",
          "label": "Author Role",
          "default": "Position"
        },
        {
          "type": "image_picker",
          "id": "author_image",
          "label": "Author Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Expandable Cards",
      "blocks": [
        {
          "type": "card",
          "settings": {
            "title": "Summer Opening",
            "description": "Join us for the Summer Opening event, where we celebrate the start of a vibrant season filled with art and culture.",
            "author_name": "Eduardo Calvo",
            "author_role": "CEO & Founder"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Fashion",
            "description": "Explore the latest trends in fashion at our exclusive showcase, featuring renowned designers and unique styles.",
            "author_name": "Sarah Chen",
            "author_role": "Head of Design"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Gallery Art",
            "description": "Immerse yourself in the world of art at our gallery, showcasing stunning pieces from emerging and established artists.",
            "author_name": "Marcus Johnson",
            "author_role": "Lead Developer"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Dreams",
            "description": "Join us on a journey through dreams, exploring the subconscious and the art of dreaming.",
            "author_name": "Emily Rodriguez",
            "author_role": "Product Manager"
          }
        }
      ]
    }
  ]
}
{% endschema %}